<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOEZIE - Checkout</title>    
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">   
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">   
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="/styles/user/partials/navbar.css">
    
    <style>
         .summary-card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .address-field {
            margin-bottom: 15px; /* Space between fields */
        }
        .product-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px; /* Reduced gap */
            padding: 5px 10px; /* Padding around the product info */
            border: 1px solid #ddd; /* Border for product details */
            border-radius: 5px; /* Rounded corners */
        }
        .product-summary img {
            width: 50px; /* Image size */
            margin-right: 20px; /* Space between image and text */
            border-radius: 7px;
        }
        .product-details {
            text-align: left; /* Center the product name and size */
            flex-grow: 1;
        }
        .product-price {
            text-align: right; /* Align price to the right */
            width: 100px; /* Fixed width for price */
        }
        .pricing-summary {
            margin-top: 10px;
        }
        .quantity-details{
            text-align: center;
            flex-grow: 1;
        }

        .list-group-item{
            padding: 2px 10px;
            border: none;
            background: transparent;
        }
        /* .summary-card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        } */
        .address-field {
            margin-bottom: 15px; /* Space between fields */
        }
        .error-message {
            color: red;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<%- include('partials/navbar') %>

<main class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <h5>Select Saved Address</h5>
            <select class="form-control" id="addressSelect" onchange="populateAddress()">
                <option value="">Select an address</option>
                <% if(address){ %>
                    <% address.forEach(address =>{ %>
                        <option 
                            value="<%= address.fullname %>" 
                            data-email="<%= address.email %>" 
                            data-address="<%= address.address %>,<%=address.city%>,<%=address.district%>,<%=address.state%>,<%=address.country%>" 
                            data-pincode="<%= address.pincode %>" 
                            data-phone="<%= address.phoneNumber %>">
                            <%= address.fullname %>
                        </option>
                    <% }) %>
                <% } %>
            </select>
        
            <h5 class="mt-4">Shipping Information</h5>
            <form id="shippingForm">
                <input type="text" class="form-control address-field" placeholder="Full Name" required oninput="validateFullName()">
                <div class="error-message" id="fullNameError"></div>

                <!-- <input type="email" class="form-control address-field" placeholder="Email" required oninput="validateEmail()">
                <div class="error-message" id="emailError"></div> -->

                <textarea class="form-control address-field" placeholder="Address" rows="3" required oninput="validateAddress()"></textarea>
                <div class="error-message" id="addressError"></div>

                <input type="text" class="form-control address-field" placeholder="Pincode" required oninput="validatePincode()">
                <div class="error-message" id="pincodeError"></div>

                <input type="text" class="form-control address-field" placeholder="Phone Number" required oninput="validatePhone()">
                <div class="error-message" id="phoneError"></div>
            </form>
        </div>
        
        <div class="col-md-6">
            <h5>Order Summary</h5>
            <div class="summary-card">
                <% let subtotal = 0; let totalDiscount = 0; %> 
                <% if(cart) { %>
                   
                    <div id="cartData" data-cart='<%= JSON.stringify(cart) %>'></div>
                    <% cart.products.forEach(cart => { %>
                      
                        <div class="product-summary">
                            <img src="<%= cart.productId.imageUrls[0] %>" alt="product img" width="50">
                            <div class="product-details">
                                <strong><%= cart.productId.name %></strong><br>
                                <% const size = cart.productId.sizes.find(size => size._id.toString() === cart.sizeId.toString()) %>
                                <span>Size: <%= size.size %></span>
                            </div>
                            <div class="quantity-details">
                                <span>x <%= cart.quantity %></span>
                            </div>
                            <div class="product-price">
                               <p class="price">
                            <% let originalPrice = cart.productId.price; %>
                            <% let finalPrice = originalPrice; %>
                            <% let discountAmount = 0; %>

                            <% if (cart.bestOffer) { %>
                                <span style="text-decoration: line-through; color: gray; margin-right: 5px;">
                                    ₹ <%= (originalPrice).toFixed(2) %>
                                </span><br>
                                <% if (cart.bestOffer.offerType === 'percentage') { %>
                                    <% 
                                    discountAmount = Math.min(
                                        (originalPrice * cart.bestOffer.value) / 100,
                                        cart.bestOffer.maxDiscount || Infinity
                                    ); 
                                    finalPrice = originalPrice - discountAmount;
                                    %>
                                <% } else if (cart.bestOffer.offerType === 'flat') { %>
                                    <% 
                                    discountAmount = cart.bestOffer.value;
                                    finalPrice = originalPrice - discountAmount;
                                    %>
                                <% } %>
    
                                ₹ <%= finalPrice.toFixed(2) %>
                            <% } else { %>
                                ₹ <%= originalPrice.toFixed(2) %>
                            <% } %>
                        </p>
                            </div>
                        </div>    
                        <% subtotal += finalPrice * cart.quantity; %>
                        <% totalDiscount += discountAmount * cart.quantity; %>  
                    <% }); %>
                <% } %>
                
                <div class="pricing-summary">
                    <!-- <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹ <%= subtotal %></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Discount:</span>
                            <span id="discount">₹ 0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Delivery Fee:</span>
                            <span>₹ 0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong id="total">₹ <%= subtotal %></strong>
                        </li>
                    </ul> -->
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹ <%= (subtotal+totalDiscount).toFixed(2) %></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>You Saved:</span>
                            <span id="offerDiscount">₹ <%= totalDiscount.toFixed(2) %></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Coupon Discount:</span>
                            <span id="couponDiscount">₹ 0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Delivery Fee:</span>
                            <span>₹ 0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong id="total">₹ <%= (subtotal).toFixed(2) %></strong>
                        </li>
                    </ul>
                    <div class="mt-3 d-flex " style="gap:10px;">
                        <input type="text" id="couponCode" class="form-control" placeholder="Enter Coupon Code" />
                        <button class="btn btn-primary "  onclick="applyCoupon()">Apply </button>
                    </div>
                    <div class="mt-3">
                        <h5 class="mt-3">Payment Method</h5>
                        <div class="payment-option">
                            <input type="radio" id="razorpay" name="paymentMethod" value="razorpay" required />
                            <label for="razorpay">Pay with Razorpay</label>
                          </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cashOnDelivery">
                            <label class="form-check-label" for="cod">
                                Cash on Delivery
                            </label>
                        </div>
                    </div>
                    <div class="text-left mt-3">
                        <button id="placeOrderButton" class="btn btn-success" disabled>Place Order <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    const placeOrderButton = document.getElementById('placeOrderButton');

    function validateFullName() {
        const fullNameInput = document.querySelector('input[placeholder="Full Name"]');
        const errorMessage = document.getElementById('fullNameError');
        const isValid = fullNameInput.value.trim() !== '';

        errorMessage.textContent = isValid ? '' : 'Full Name is required.';
        checkFormValidity();
    }

    // function validateEmail() {
    //     const emailInput = document.querySelector('input[placeholder="Email"]');
    //     const errorMessage = document.getElementById('emailError');
    //     const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value);

    //     errorMessage.textContent = isValid ? '' : 'Please enter a valid email address.';
    //     checkFormValidity();
    // }

    function validateAddress() {
        const addressInput = document.querySelector('textarea[placeholder="Address"]');
        const errorMessage = document.getElementById('addressError');
        const isValid = addressInput.value.trim() !== '';

        errorMessage.textContent = isValid ? '' : 'Address is required.';
        checkFormValidity();
    }

    function validatePincode() {
        const pincodeInput = document.querySelector('input[placeholder="Pincode"]');
        const errorMessage = document.getElementById('pincodeError');
        const isValid = /^\d{6}$/.test(pincodeInput.value); // Assuming Indian pin codes

        errorMessage.textContent = isValid ? '' : 'Please enter a valid 6-digit pincode.';
        checkFormValidity();
    }

    function validatePhone() {
        const phoneInput = document.querySelector('input[placeholder="Phone Number"]');
        const errorMessage = document.getElementById('phoneError');
        const isValid = /^\d{10}$/.test(phoneInput.value); // Assuming 10-digit phone numbers

        errorMessage.textContent = isValid ? '' : 'Please enter a valid 10-digit phone number.';
        checkFormValidity();
    }

    function checkFormValidity() {
        const fullNameValid = document.getElementById('fullNameError').textContent === '';
        // const emailValid = document.getElementById('emailError').textContent === '';
        const addressValid = document.getElementById('addressError').textContent === '';
        const pincodeValid = document.getElementById('pincodeError').textContent === '';
        const phoneValid = document.getElementById('phoneError').textContent === '';

        // Enable the button only if all validations pass
        placeOrderButton.disabled = !(fullNameValid && addressValid && pincodeValid && phoneValid);
    }

    function populateAddress() {
        const addressSelect = document.getElementById('addressSelect');
        const fullnameInput = document.querySelector('input[placeholder="Full Name"]');
        // const emailInput = document.querySelector('input[placeholder="Email"]');
        const addressInput = document.querySelector('textarea[placeholder="Address"]');
        const pincodeInput = document.querySelector('input[placeholder="Pincode"]');
        const phoneInput = document.querySelector('input[placeholder="Phone Number"]');
    
        const selectedOption = addressSelect.options[addressSelect.selectedIndex];
    
        if (selectedOption.value) {
            // Populate the input fields with the selected address details
            fullnameInput.value = selectedOption.value;
            // emailInput.value = selectedOption.getAttribute('data-email');
            addressInput.value = selectedOption.getAttribute('data-address');
            pincodeInput.value = selectedOption.getAttribute('data-pincode');
            phoneInput.value = selectedOption.getAttribute('data-phone');
        } else {
            // Clear the fields if no valid address is selected
            fullnameInput.value = '';
            // emailInput.value = '';
            addressInput.value = '';
            pincodeInput.value = '';
            phoneInput.value = '';
        }

        validateFullName();
        // validateEmail();
        validateAddress();
        validatePincode();
        validatePhone();
    }

async function placeOrder() {
    const fullName = document.querySelector('input[placeholder="Full Name"]').value;
    const address = document.querySelector('textarea[placeholder="Address"]').value;
    const pincode = document.querySelector('input[placeholder="Pincode"]').value;
    const phoneNumber = document.querySelector('input[placeholder="Phone Number"]').value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const couponCode = document.getElementById('couponCode').value || null
    let  couponDiscount = document.getElementById('couponDiscount').innerHTML || 0
    let  offerDiscount = document.getElementById('offerDiscount').innerHTML || 0
    couponDiscount = couponDiscount.replace(/[₹\s]/g, '');
    parseFloat(couponDiscount);

    offerDiscount = offerDiscount.replace(/[₹\s]/g, '');
    parseFloat(offerDiscount);

    const cartElement = document.getElementById('cartData');
    const cart = JSON.parse(cartElement.getAttribute('data-cart'));

    const items = cart.products.map(item => ({
        productId: item.productId._id,
        sizeId: item.sizeId,
        quantity: item.quantity,
        price: item.productId.price
    }));


    let totalAmount = cart.products.reduce((acc, item) => acc + (item.productId.price * item.quantity), 0);
     totalAmount-=couponDiscount
     totalAmount-=offerDiscount
    const shippingAddress = {
        fullname: fullName,
        address,
        pincode,
        phone: phoneNumber
    };

    const orderData = { items, totalAmount, shippingAddress,
         paymentMethod,couponCode,offerDiscount,couponDiscount };

    if (paymentMethod === 'cashOnDelivery') {
        // Place COD order       
        confirmOrder(orderData);
    } else {
        // Trigger Razorpay payment
        launchRazorpay(orderData);
    }
}

async function confirmOrder(orderData, razorpayResponse) {
    if (razorpayResponse) {
        // Add paymentId, orderId, and signature only if they are present
        orderData.paymentId = razorpayResponse.razorpay_payment_id; 
        orderData.orderId = razorpayResponse.razorpay_order_id; 
        orderData.signature = razorpayResponse.razorpay_signature; 
    }

    try {
        const response = await fetch('/user/cart/checkout/confirm-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });
        console.log(orderData);
        if (response.ok) {          
            const data = await response.json();
            Toastify({
                text: data.message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: 'center',
                backgroundColor: "#4CAF50",
            }).showToast();

            setTimeout(() => {
                window.location.href = '/user/profile/orders'; // Redirect to orders page
            }, 3000);
        } else {
            alert('Error placing order. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('There was an issue placing your order.');
    }
}

async function fetchRazorpayKey() {
    try {
        const response = await fetch('/get-razorpay-key');
        const data = await response.json();
        return data.key;
    } catch (error) {
        console.error('Error fetching Razorpay key:', error);
    }
}

async function launchRazorpay(orderData) {
    const razorpayKey = await fetchRazorpayKey();
    const options = {
        key: razorpayKey,
        amount: orderData.totalAmount * 100, // Amount in paisa (1 INR = 100 paisa)
        currency: "INR",
        name: "SHOEZIE",
        description: "Order Payment",
        handler: async function (response) {
            console.log(response);
            
            // Capture payment ID, order ID, and signature from the response
            orderData.paymentId = response.razorpay_payment_id; 
            orderData.orderId = response.razorpay_order_id; // Ensure this is added
            orderData.signature = response.razorpay_signature; // Ensure this is added
            
            // Call confirmOrder with the orderData and the response
            await confirmOrder(orderData, response); // Pass the entire response to confirmOrder
        },
        prefill: {
            name: orderData.shippingAddress.fullname,
            contact: orderData.shippingAddress.phone,
        },
        theme: {
            color: "#3399cc",
        },
        modal: {
            ondismiss: function () {
                Toastify({
                    text: "Payment cancelled!",
                    duration: 3000,
                    backgroundColor: "#f44336"
                }).showToast();
            }
        }
    };

    const rzp = new Razorpay(options);
    rzp.open();
}


document.getElementById('placeOrderButton').addEventListener('click', function (e) {
    e.preventDefault(); // Prevent form submission
    placeOrder();
});

// placeOrderButton.addEventListener('click', function (e) {
//         e.preventDefault(); // Prevent form submission (since we're using JavaScript to handle it)
//         placeOrder();
//     });

    function applyCoupon() {
    const couponCode = document.getElementById('couponCode').value.trim();
    let subtotal = document.getElementById('total').innerText
     subtotal = subtotal.replace(/[₹\s]/g, '');
parseFloat(subtotal);

console.log(subtotal);

    if (!couponCode) {
        Toastify({
            text: 'Please enter a coupon code',
            duration: 3000,
            backgroundColor: "#f44336"
        }).showToast();
        return;
    }

    fetch(`/user/cart/coupon/validate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: couponCode, subtotal })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('couponDiscount').innerText = `₹ ${data.discountAmount.toFixed(2)}`;
                const total = subtotal - data.discountAmount;
                document.getElementById('total').innerText = `₹ ${total.toFixed(2)}`;
                Toastify({
                    text: 'Coupon applied successfully!',
                    duration: 3000,
                    backgroundColor: "#4CAF50"
                }).showToast();
            } else {
                Toastify({
                    text: data.message,
                    duration: 3000,
                    backgroundColor: "#f44336"
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Toastify({
                text: 'An error occurred. Please try again.',
                duration: 3000,
                backgroundColor: "#f44336"
            }).showToast();
        });
}

</script>

</body>
</html>
