<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOEZIE - Product View</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="/styles/user/partials/navbar.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f4f4;
        }

        .container {
            display: flex;
            margin-top: 20px;
        }

        .thumbnails {
            width: 20%;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .thumbnail {
            cursor: pointer;
            margin-bottom: 20px;
            width: 85px;
            height: 85px;
            border: 1px solid rgb(222, 218, 218);
            border-radius: 10px;
        }

        .main-image {
            width: 30%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .product-image {
            max-height: 350px;
            object-fit: cover;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .zoom-preview {
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 10px;
            display: none;
            overflow: hidden;
            z-index: 100;
            width: 200px;
            height: 200px;
            pointer-events: none; /* Prevent interactions */
        }

        .zoom-preview img {
            width: 300%; /* Make it larger for zoom */
            height: auto; /* Maintain aspect ratio */
        }

        .product-details {
            width: 40%;
            margin-top: 20px;
            margin-left: auto;
        }

        .price {
            font-weight: bold;
            font-size: 1.2em;
            margin: 0;
        }

        .description {
            font-size: 0.9em;
            color: #666;
        }

        .line {
            border-top: 1px solid #ccc;
            margin: 15px 0;
        }

        .size-button {
            margin: 5px;
        }

        .related-products {
            margin-top: 60px;
            padding-bottom: 100px;
            position: relative;
        }

        .related-products h4 {
            text-align: left;
            margin-bottom: 20px;
            margin-left: 80px;
        }

        .related-products-wrapper {
            display: flex;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .related-product {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
            text-align: left;
            width: 170px;
            margin: 0 20px;
            flex: none;
        }

        .related-product img {
            width: 100%;
            height: 170px;
            object-fit: cover;
        }

        .related-product h5 {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .related-product .price {
            font-size: 0.8em;
            margin: 0;
        }

        .rating {
            color: #ffcc00;
            font-size: 0.8em;
            margin: 0;
        }

        .scroll-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 1;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scroll-left {
            left: 80px;
        }

        .scroll-right {
            right: 80px;
        }
        .selected {
        background-color: black; /* Black background */
        color: white; /* White text */
    }
    </style>
</head>
<body>

<!-- Navbar -->
<%- include('partials/navbar') %>
<!-- Product View Section -->
<div class="container">
    <% if(product){%>
        <div class="thumbnails">
            <% product.imageUrls.forEach((url,index)=>{ %>
           <img src="<%= url %>" class="thumbnail" alt="Thumbnail 1" onclick="changeMainImage('<%=url %>')">
           <% }) %>
        </div>
    
        <div class="main-image" onmousemove="zoom(event)" onmouseleave="hideZoom()">
            <img id="mainImage" src="<%= product.imageUrls[0]%>" class="product-image" alt="Product Image">
            <div class="zoom-preview" id="zoomPreview">
                <img src="<%= product.imageUrls[0]%>" alt="Zoomed Image" id="zoomedImage">
            </div>
        </div>
    
        <div class="product-details">
            <h5 class="card-title"><%= product.name %></h5>
            <div>
                <span class="text-warning">★★★★☆ (4.0)</span>
            </div>
            <p class="price">₹ <%= product.price %>.00</p>
            <div class="line"></div>
            <label>Stock:</label>
            <div>
                <p id="product-stock" class="font-weight-bold"></p>
                <!-- <span class="badge badge-primary" style="cursor: pointer;">Blue</span>
                <span class="badge badge-danger" style="cursor: pointer;">Red</span>
                <span class="badge badge-success" style="cursor: pointer;">Green</span> -->
            </div>
            <div class="line"></div>
            <label>Available Sizes:</label>
      <div id="size-selection">
    <% product.sizes.forEach(size => { %>
        <button 
            class="btn btn-outline-secondary size-button" 
            data-size="UK<%= size.size %>"
            onclick="selectSize(this,'<%=size.stock %>','<%=size._id %>')">
            UK<%= size.size %>
        </button>
    <% }) %>

</div>

<input type="hidden" id="selected-size" name="size" />
            <div class="line"></div>
            <p class="description"><%= product.description %></p>
            <div class="line"></div>
            <div>
                <button onclick="addToCart('<%= product._id %>')" id="addToCart"  class="btn btn-primary" >Add To Cart</button>
                <button id="addToFav" class="btn btn-secondary " >Add To Fav</button>
            </div>
        </div>
    <%} %>  
</div>

<!-- You Might Also Like Section -->
<div class="related-products">
    <h4>You Might Also Like</h4>
    <div class="related-products-wrapper">
        <button class="scroll-button scroll-left" onclick="scrollLeft()">&#10094;</button>
        <div class="related-product">
            <img src="https://via.placeholder.com/150" alt="Related Product 1">
            <h5>Related Product 1</h5>
            <p class="rating">★★★★☆ (4.0)</p>
            <p class="price">₹ 1,999</p>
        </div>
        <div class="related-product">
            <img src="https://via.placeholder.com/150" alt="Related Product 2">
            <h5>Related Product 2</h5>
            <p class="rating">★★★☆☆ (3.5)</p>
            <p class="price">₹ 2,199</p>
        </div>
        <div class="related-product">
            <img src="https://via.placeholder.com/150" alt="Related Product 3">
            <h5>Related Product 3</h5>
            <p class="rating">★★★★☆ (4.0)</p>
            <p class="price">₹ 2,399</p>
        </div>
        <div class="related-product">
            <img src="https://via.placeholder.com/150" alt="Related Product 4">
            <h5>Related Product 4</h5>
            <p class="rating">★★★★☆ (4.0)</p>
            <p class="price">₹ 2,599</p>
        </div>
        <div class="related-product">
            <img src="https://via.placeholder.com/150" alt="Related Product 5">
            <h5>Related Product 5</h5>
            <p class="rating">★★★☆☆ (3.0)</p>
            <p class="price">₹ 1,299</p>
        </div>
        <button class="scroll-button scroll-right" onclick="scrollRight()">&#10095;</button>
    </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    function changeMainImage(imageUrl) {
        const mainImage = document.getElementById('mainImage');
        mainImage.src = imageUrl;
        document.getElementById('zoomedImage').src = imageUrl; // Update zoom image
    }

    function zoom(event) {
        const img = document.getElementById('mainImage');
        const zoomPreview = document.getElementById('zoomPreview');
        const zoomedImage = document.getElementById('zoomedImage');

        const x = event.offsetX;
        const y = event.offsetY;
        const width = img.offsetWidth-90;
        const height = img.offsetHeight-90;

        const xPercent = (x / width) * 100;
        const yPercent = (y / height) * 100;

        zoomPreview.style.display = 'block'; // Show zoom preview
        zoomPreview.style.left = (event.pageX -450)+ 'px'; // Position the preview
        zoomPreview.style.top = (event.pageY -200)+ 'px';
        
        // Set the transform origin and scale for the zoomed image
        zoomedImage.style.transformOrigin = `${xPercent}% ${yPercent}%`;
        zoomedImage.style.transform = `scale(3)`; // Scale the zoomed image
    }

    function hideZoom() {
        const zoomPreview = document.getElementById('zoomPreview');
        zoomPreview.style.display = 'none'; // Hide zoom preview
    }

    function scrollLeft() {
        const wrapper = document.querySelector('.related-products-wrapper');
        wrapper.scrollBy({ left: -160, behavior: 'smooth' });
    }

    function scrollRight() {
        const wrapper = document.querySelector('.related-products-wrapper');
        wrapper.scrollBy({ left: 160, behavior: 'smooth' });
    }


let sizeId=''
    function selectSize(button,stock,id) {
        // Deselect all buttons
        sizeId=id
        const buttons = document.querySelectorAll('.size-button');
        buttons.forEach(btn => {
            btn.classList.remove('selected');
            btn.classList.remove('btn-secondary'); // Remove the secondary style
            btn.classList.add('btn-outline-secondary'); // Add outline style back
        });

        // Select the clicked button
        button.classList.add('selected');
        button.classList.remove('btn-outline-secondary'); // Remove outline style
        button.classList.add('btn-selected'); // Add the custom selected style

        // Update the hidden input with the selected size
        // document.getElementById('selected-size').value = button.getAttribute('data-size');
        const stockElement=document.getElementById('product-stock')
        const addToCart = document.getElementById('addToCart')
        const addToFav = document.getElementById('addToFav')
        if(stock > 5){
            stockElement.innerText='In Stock'
            stockElement.style.color='Black'
            addToCart.disabled = false; 
            addToFav.disabled = false;
        }else if(stock <= 5 && stock > 0){
            stockElement.innerText= `Only ${stock} Left`
            stockElement.style.color='Red'
            addToCart.disabled = false; 
            addToFav.disabled = false;
        }else if(stock == 0){
            stockElement.innerText= `Out Of Stock`
            stockElement.style.color='Red'
            addToCart.disabled = true; // Disable the button
            addToFav.disabled = true; // Disable the button
        }
    }

    function addToCart(productId) {
    fetch(`/user/cart/add/${productId}/${sizeId}`, {
        method: 'POST', // Ensure this is POST
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + error.message);
        }
        return response.json();
    })
    .then(data => {
        if (data.message) {
            Toastify({
                text: data.message,
                duration: 3000,
                close: true,
                gravity: "bottom",
                position: 'center',
                backgroundColor: "#4CAF50",
            }).showToast();
        }
    })
    .catch(error => {
        Toastify({
            text: 'Error adding to cart:'+ error.message,
            duration: 3000,
            close: true,
            gravity: "bottom",
            position: 'center',
            backgroundColor: "#f44336",
        }).showToast();
        console.error('Error:', error);
    });
}
</script>
</body>
</html>
